---
title: "时间序列分析：第二章"
subtitle: "时间序列回归和探索性数据分析"
author: "周博霖"
date: "2024/9/11"
categories: [学习笔记,统计方法,时间序列分析]
image: "cover.png"
bibliography: references.bib
csl: apa.csl
number-sections: true
toc: true
toc-depth: 3
execute:
  freeze: auto
---

```{r chapter-status, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(webexercises)
library(astsa)
library(xts)
library(tidyverse)
options(scipen=5)
```

主要参考书籍为Shumway和Stoffer[-@Shumway_2017]的Time Series Analysis and Its Applications: With R Examples。

该书第五版正在制作，配套`astsa`包中的部分数据集会逐渐更新，所以后期也许会换成第五版内容。

该内容为学习笔记，会很碎片化，同时参考了作者在[github](https://github.com/nickpoison/tsa4/blob/master/textRcode.md)上给出的代码。

::: callout-tip
提示框表明这部分完全是个人理解，可能有误。

一切错误和想讨论的内容欢迎联系邮箱(zhoubolin0404\@126.com)，感谢！
:::

在本章中，我们将介绍时间序列背景下的经典多元线性回归、模型选择、非平稳时间序列预处理(如趋势去除)的探索性数据分析、差分(differencing)和后移算子(backshift operator)的概念、方差稳定和时间序列的非参数平滑。

# 时间序列背景下的经典回归

对于时间序列$x_t$($t=1,\cdots,n$)，受到一组可能的输入或自变量序列($z_{t1},z_{t2},\cdots,z_{tq}$)的影响。用线性回归模型来考虑这种关系，则模型为：

$$
x_t=\beta_0+\beta_1z_{t1}+\beta_2z_{t2}+\cdots+\beta_qz_{tq}+w_t
$$

其中$\beta_0,\beta_1,\cdots,\beta_q$是固定的回归系数，$w_t$是随机误差或噪声过程，均值为$0$，方差为$\sigma_w^2$，正态分布。

::: callout-tip
$z_{t}$一般就是时间。
:::

## 简单线性回归

:::{.callout-tip}
[@sec-lagreg]之前的内容就是将时间、时间的平方等变量作为自变量添加到模型中的线性回归，如果已经熟悉线性回归基础知识，可以直接跳到[@sec-lagreg]。
:::

[@fig-chicken]展示了2001年8月到2016年7月美国某码头鸡肉每月价格，直线是线性回归的拟合。

```{r, echo = FALSE, warning = FALSE, message=FALSE}
#| label: fig-chicken
#| fig-cap: 鸡肉价格
tibble(time = time(chicken), price = chicken) %>%
    ggplot(aes(x = time, y = price)) +
    geom_line() +
    geom_smooth(method = "lm") +
    labs(y = "cents per pound", x = "Time") +
    scale_y_continuous(limits = c(55, 120), breaks = seq(60, 120, 10)) +
    theme_bw()
```

拟合模型为：

$$
x_t=\beta_0+\beta_1z_t+w_t,\ z_t=2001\frac{7}{12},2001\frac{8}{12},\cdots,2016\frac{6}{12}
$$

其中$w_t$被假设为一个独立同分布的正态分布序列(如不成立需要进行额外操作，第三章会介绍)。

::: callout-tip
没看懂为什么是$2001\frac{7}{12}$到$2016\frac{6}{12}$。

之后是对一元线性回归的计算，再后面是多元的，方法类似，故不对一元的进行解释，直接给出结果。
:::

```{r}
summary(fit <- lm(chicken ~ time(chicken), na.action = NULL))
```

结果表明：斜率系数$\hat\beta_1=3.59$(标准误差为$0.08$)，$p<0.001$，结果显著。

::: callout-tip
接下来会论述多元线性回归的计算过程，方便引出Akaike信息准则(Akaike’s Information Criterion，AIC)，个人感觉不知道怎么推导也没什么问题。仅从个人理解角度进行概括，看不懂可以跳过，或者给出修改建议。
:::

## 多元线性回归

多元线性回归模型，$z_t=(z_{t1},\ z_{t2},\ \cdots,\ z_{tq})'$和$\beta=(\beta_0,\ \beta_1,\ \cdots,\ \beta_q)'$这种列向量表示起来更为方便。

模型可以表示为：

$$
x_t=\beta_0+\beta_1z_{t1}+\beta_2z_{t2}+\cdots+\beta_qz_{tq}+w_t=\beta'z_t+w_t
$$

其中$w_t\sim\operatorname{iid\ N}(0,\ \sigma_w^2)$。

普通最小二乘法(Ordinary Least Square，OLS)下，最小化的误差平方和(residual sum of squares或sum of squares for error，RSS或SSE)为：

$$
Q=\sum_{t=1}^{n}w_t^2=\sum_{t=1}^{n}(x_t-\beta'z_t)^2
$$

最小化($Q$关于$\beta$的偏导数为0)需要满足$\sum_{t=1}^n(x_t-\hat\beta'z_t)z_t'=0$(表示$w_t$和$z_t$不相关)，得到正规方程(normal equations)：

$$
(\sum_{t=1}^{n}z_tz_t')\hat\beta=\sum_{t=1}^{n}z_tx_t
$$

对这个方程求解就可以得到：

$$
\hat\beta=(\sum_{t=1}^{n}z_tz_t')^{-1}\sum_{t=1}^{n}z_tx_t
$$

所以最小化的误差平方和为：

$$
\operatorname{SSE}=\sum_{t=1}^{n}(x_t-\hat\beta'z_t)^2
$$

这是无偏的($\operatorname{E}(\hat\beta)=\beta$)，且具有最小方差。

如果误差$w_t$是正态分布，$\hat\beta$是$\beta$的最大似然估计，且具有正态分布

$$
\operatorname{cov}(\hat\beta)=\sigma_w^2C
$$

其中

$$
C=(\sum_{t=1}^{n}z_tz_t')^{-1}
$$

$C$是$z_t$的协方差矩阵的逆。

方差$\sigma_w^2$的无偏估计是

$$
s_w^2=\operatorname{MSE}=\frac{\operatorname{SSE}}{n-(q+1)}
$$

$\operatorname{SSE}$表示均方误差(mean squared error)。正态假设下

$$
t=\frac{(\hat\beta_i-\beta_i)}{s_w\sqrt{c_{ii}}}
$$

服从自由度为$n-(q+1)$的$t$分布，$c_{ii}$表示矩阵$C$的第$i$个对角线元素。对于$i=1,\ \cdots,\ q$，该结果常用于检验零假设$\operatorname{H_0}:\beta_t=0$.

竞争模型关注隔离或选择最佳自变量子集点。选择$r<q$个独立模型，即$z_{t,1:r}={z_{t1},\ z_{t2},\ \cdots,\ z_{tr}}$。模型为

$$
x_t=\beta_0+\beta_1z_{t1}+\cdots+\beta_rz_{tr}+w_t
$$

零假设为$\operatorname{H_0}:\beta_{r+1}=\cdots=\beta_q=0$，使用$F$检验

$$
F=\frac{(\operatorname{SSE}_r-\operatorname{SSE}/(q-r))}{\operatorname{SSE}/(n-q-1)}=\frac{\operatorname{MSR}}{\operatorname{MSE}}
$$

在自由度为$q-r$和$n-q-1$的$F$分布中进行检验。

整体逻辑是看添加上其他自变量，是否显著增加拟合效果。如果$\operatorname{H}_0$为真，则可以化简模型，反之则不可以。

|    误差源     | 自由度(df) |                            平方和                            |                      均方                       |                       $F$值                       |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| $z_{t,r+1:q}$ |   $q-r$    | $\operatorname{SSR}=\operatorname{SSE}_r-\operatorname{SSE}$ |  $\operatorname{MSR}=\operatorname{SSR}/(q-r)$  | $F=\frac{\operatorname{MSR}}{\operatorname{MSE}}$ |
|     Error     | $n-(q+1)$  |                     $\operatorname{SSE}$                     | $\operatorname{MSE}=\operatorname{SSE}/(n-q-1)$ |                                                   |

: 回归分析的方差分析 {#tbl-ranova}

当$\beta_1=\cdots=\beta_q=0$时，$x_t=\beta_0+w_t$，有：

$$
R^2=\frac{\operatorname{SSE}_0-\operatorname{SSE}}{\operatorname{SSE}_0}\\
\operatorname{SSE}_0=\sum_{t=1}^n(x_t-\bar x)^2
$$

$R^2$是决定系数(coefficient of determination)。

通过上述$F$检验来选择变量的纳入或删除，这就是逐步多元回归(stepwise multiple regression)。

下面介绍通过模型优度来进行模型选择的方法。

### 信息准则

$k$个系数的正态回归模型，方差的最大似然估计可表示为：

$$
\hat\sigma_k^2=\frac{\operatorname{SSE}(k)}{n}
$$

其中$\operatorname{SSE}(k)$表示$k$个回归系数的模型的残差平方和。显然$\operatorname{SSE}(k)$会随着$k$的增加而单调减少。

信息准则的基本思路是在最小化$\hat\sigma_k^2$的同时，添加一个随$k$的增加而单调增加的惩罚项，来选择合适的参数数量。

#### Akaike信息准则(Akaike’s Information Criterion，AIC)

$$
\operatorname{AIC}=\log\hat\sigma_k^2+\frac{n+2k}{n}
$${#eq-aicsp}

最常用。

#### AIC，偏差修正(AICc)

$$
\operatorname{AICc}=\log\hat\sigma_k^2+\frac{n+k}{n-k-2}
$$

适用于参数数量相对较大，但样本量较小的情况。

#### 贝叶斯信息准则(Bayesian Information Criterion，BIC)

$$
\operatorname{BIC}=\log\hat\sigma_k^2+\frac{k\log n}{n}
$$

BIC惩罚项的值远大于AIC，适合在大样本中选出较小的模型，防止过拟合。

:::{.callout-tip}
这里的AIC，BIC都不是标准模式，是在正态分布线性回归中的一种等效形式。`R`中`AIC()`函数和`BIC()`函数使用的是通用形式。

以AIC为例，通用形式为：

$$
\operatorname{AIC}(k)=2k-2\log(L)
$${#eq-aic1}

其中$k$是参数个数，$L$是似然函数最大值，这是`AIC()`函数得到的结果。在某些模型中可转换为：

$$
\operatorname{AIC}(k)=2k+n\log(\hat\sigma_k^2)
$${#eq-aic2}

其中其中$n$是样本量，$\hat\sigma_k^2$是均方误差估计值。[@eq-aic1]和[@eq-aic2]在成立时是等价的，[@eq-aic2]可通过下列公式转换为[@eq-aicsp]。

$$
\operatorname{AIC}_1=\frac{\operatorname{AIC}_2}{n}-\log(2\pi)
$$

其中$\operatorname{AIC}_1$是[@eq-aicsp]的值，$\operatorname{AIC}_2$是[@eq-aic1]的值。BIC也可以通过相似公式转换。

AIC和BIC的具体值并不是关注的重点，更需要关注的是一组模型中，同一算法下值的变化，值越小越好。
:::

### 模型选择

[@fig-card]展示1970-1979年间洛杉矶温度、污染和心血管死亡率的变化。展现出强烈的对于冬夏季节的变化，且死亡率整体为下降趋势。

```{r, echo = FALSE, warning = FALSE, message=FALSE}
#| label: fig-card
#| fig-cap: 洛杉矶地区平均每周心血管死亡率(上)、温度(中)、颗粒污染(下)
par(mfrow=c(3,1))
tsplot(cmort, main="Cardiovascular Mortality", col=6, type="o", pch=19, ylab="")
tsplot(tempr, main="Temperature", col=4, type="o", pch=19, ylab="")
tsplot(part, main="Particulates", col=2, type="o", pch=19, ylab="")
```



```{r, echo = FALSE, warning = FALSE, message=FALSE}
#| label: fig-cardcor
#| fig-cap: 散点图矩阵(左下方是相关系数)
panel.cor <- function(x, y, ...){
usr <- par("usr")
par(usr = c(0, 1, 0, 1))
r <- round(cor(x, y), 2)
text(0.5, 0.5, r, cex = 1.75)
}
pairs(cbind(Mortality=cmort, Temperature=tempr, Particulates=part), col=4, lower.panel=panel.cor)
```

我们可以假设$4$种模型，其中$M_t$表示心血管死亡率，$T_t$表示温度，$P_t$表示颗粒水平，$T.$是$T_t$的平均值$74.26$，用于调整温度，避免共线性问题。模型如下：

$$
M_t=\beta_0+\beta_1t+w_t
$$ {#eq-2_18}
$$
M_t=\beta_0+\beta_1t+\beta_2(T_t-T.)+w_t
$$ {#eq-2_19}
$$
M_t=\beta_0+\beta_1t+\beta_2(T_t-T.)+\beta_3(T_t-T.)^2+w_t
$$ {#eq-2_20}
$$
M_t=\beta_0+\beta_1t+\beta_2(T_t-T.)+\beta_3(T_t-T.)^2+\beta_4P_t+w_t
$$ {#eq-2_21}

[@eq-2_18]是简单的趋势模型；[@eq-2_19]额外添加了线性的温度变量；[@eq-2_20]温度变量是二次的；[@eq-2_21]还添加了污染变量。

```{r,echo=FALSE}
temp  = tempr - mean(tempr)
temp2 = temp ^ 2
trend = time(cmort)
fit1 = lm(cmort ~ trend)
fit2 = lm(cmort ~ cbind(trend, temp))
fit3 = lm(cmort ~ cbind(trend, temp, temp2))
fit4 = lm(cmort ~ cbind(trend, temp, temp2, part))
s1=summary(aov(fit1))
s2=summary(aov(fit2))
s3=summary(aov(fit3))
s4=summary(aov(fit4))
num = length(cmort)
```

|模型|$k$|误差平方和(SSE)|自由度(df)|均方和(MSE)|可决系数($R^2$)|AIC|BIC|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|[@eq-2_18]|`r s1[[1]]$Df[1]`|`r s1[[1]]$"Sum Sq"[2] %>% round(0)`|`r s1[[1]]$Df[2]`|`r s1[[1]]$"Mean Sq"[2] %>% round(1)`|`r summary(fit1)$r.squared %>% round(2)`|`r (AIC(fit1)/num-log(2*pi)) %>% sprintf("%.2f", .)`|`r (BIC(fit1)/num-log(2*pi)) %>% sprintf("%.2f", .)`|
|[@eq-2_19]|`r s2[[1]]$Df[1]`|`r s2[[1]]$"Sum Sq"[2] %>% round(0)`|`r s2[[1]]$Df[2]`|`r s2[[1]]$"Mean Sq"[2] %>% round(1)`|`r summary(fit2)$r.squared %>% round(2)`|`r (AIC(fit2)/num-log(2*pi)) %>% sprintf("%.2f", .)`|`r (BIC(fit2)/num-log(2*pi)) %>% sprintf("%.2f", .)`|
|[@eq-2_20]|`r s3[[1]]$Df[1]`|`r s3[[1]]$"Sum Sq"[2] %>% round(0)`|`r s3[[1]]$Df[2]`|`r s3[[1]]$"Mean Sq"[2] %>% round(1)`|`r summary(fit3)$r.squared %>% round(2)`|`r (AIC(fit3)/num-log(2*pi)) %>% sprintf("%.2f", .)`|`r (BIC(fit3)/num-log(2*pi)) %>% sprintf("%.2f", .)`|
|[@eq-2_21]|`r s4[[1]]$Df[1]`|`r s4[[1]]$"Sum Sq"[2] %>% round(0)`|`r s4[[1]]$Df[2]`|`r s4[[1]]$"Mean Sq"[2] %>% round(1)`|`r summary(fit4)$r.squared %>% round(2)`|`r (AIC(fit4)/num-log(2*pi)) %>% sprintf("%.2f", .)`|`r (BIC(fit4)/num-log(2*pi)) %>% sprintf("%.2f", .)`|

: 模型汇总 {#tbl-mort}

对比[@eq-2_18]和[@eq-2_21]，检验$\operatorname{H}_0:\beta_2=\beta_3=\beta_4=0$。

$$
F_{3,503}=\frac{(40020-20508)/3}{20508/503}\approx160>F_{3,503}(0.001)
$$

拒绝$\operatorname{H}_0$。

```{r}
temp  = tempr - mean(tempr)
temp2 = temp ^ 2
trend = time(cmort)
fit = lm(cmort ~ trend + temp + temp2 + part, na.action = NULL) # na.action用来保存残差和拟合值的时间属性
summary(fit)
```

进一步分析就需要检查残差$\hat w_t=M_t-\hat M_t$的自相关，这个在第三章会进行讲解。

### 滞后回归(Lagged Regression){#sec-lagreg}

```{r,results='hide'}
#| label: fig-soirec_ccf
#| fig-cap: SOI序列和新鱼数量序列的CCF
ccf2(soi, rec, main="SOI vs 新鱼数量")
```

[@fig-soirec_ccf]是第一章中提到的SOI和新鱼数量数据，当时是认为时间$t-6$测量的SOI和时间$t$的新鱼数量相关，现在进行检验(虽然这不是线性的，但我们先用线性进行检验)。

模型如下：

$$
R_t=\beta_0+\beta_1S_{t-6}+w_t
$$

其中$R_t$是时间$t$时的新鱼数量，$S_{t-6}$是时间$t-6$时的SOI，假设$w_t$是白噪声。

```{r}
# 创建对齐的数据框
fish = ts.intersect(rec, soiL6 = stats::lag(soi, -6), dframe = TRUE)
summary(fit <- lm(rec ~ soiL6, data = fish, na.action = NULL))
```

也可以借助`dynlm`包来完成。

```{r, warning=FALSE}
library(dynlm)
summary(fit2 <- dynlm(rec ~ L(soi, 6)))
```

`fit2`还保留了时间信息。



```{r, results='hide'}
#| label: fig-soiresid
#| fig-cap: 残差情况
par(mfrow=2:1)
tsplot(resid(fit))
acf1(resid(fit))
```

可见残差不是白噪声，之后需要进一步分析。

